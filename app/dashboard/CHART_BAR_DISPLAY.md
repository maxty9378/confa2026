# Отображение столбиков диаграммы — какие коды отвечают за высоту

## Проблема

Столбик остаётся с `min-height: 4px` и не меняется, хотя задано `height: 50%` и т.п. Причина: **процентная высота (`height: X%`) считается от высоты родителя**. Если у родителя нет явной высоты (есть циклическая зависимость или высота задаётся только контентом), браузер трактует `height: X%` как `auto`, и блок сжимается до `min-height: 4px`.

---

## 1. Где задаётся высота столбика (число)

**Файл:** `app/dashboard/page.tsx`

- Значения приходят в компонент: `pollValue`, `testValue` (из API/SSE и настроек).
- Нормализация в проценты 0–100:
  - `const pPoll = Math.max(0, Math.min(100, pollValue));`
  - `const pTest = Math.max(0, Math.min(100, testValue));`
- Высота столбика задаётся инлайн-стилем от этого процента:
  - Опрос: `style={{ height: \`${pPoll}%\` }}` на элементе с классом `barFillPoll`.
  - Тест: `style={{ height: \`${pTest}%\` }}` на элементе с классом `barFillTest`.

Если с сервера приходят `null` или 0, в разметке подставляется `stats.averageSv ?? 0` / `stats.averageGdf ?? 0`, поэтому столбик будет 0% и визуально останется `min-height: 4px`.

---

## 2. Разметка (DOM) столбика

**Файл:** `app/dashboard/page.tsx`, функция `ChartSection`

Цепочка контейнеров:

```
.section
  └ .chart
       └ .barsArea
            └ .barGroup
                 └ .barWrapper          ← родитель, от которого считается % высоты столбика
                      ├ .barValue       (подпись над столбиком)
                      └ .barFillPoll    ← здесь style={{ height: `${pPoll}%` }}
```

Для столбика теста то же самое с `.barFillTest` и `height: ${pTest}%`.

---

## 3. CSS, отвечающий за высоту и отображение

**Файл:** `app/dashboard/page.module.css`

### 3.1 Контейнер области столбиков

- **`.barsArea`**  
  - `height: 100%` — занимает высоту `.chart`.  
  - `align-items: flex-end` — по умолчанию прижимает дочерние блоки к низу; при этом дочерние **не растягиваются** по высоте, и высота `.barGroup` могла бы зависеть только от контента (цикл с процентами).

### 3.2 Группа одного столбика (опрос или тест)

- **`.barGroup`**  
  - `flex: 1` — занимает долю ширины.  
  - **`align-self: stretch`** — важно: переопределяет `align-items: flex-end` родителя и заставляет блок растягиваться на **всю высоту** `.barsArea`. Так у контейнера столбика появляется **явная высота**, и проценты у дочерних элементов считаются корректно.

### 3.3 Обёртка столбика (высота «шкалы» 0–100%)

- **`.barWrapper`**  
  - `flex: 1` — занимает всё доступное место по вертикали внутри `.barGroup` (кроме подписи `.barCaption`).  
  - **`height: 0`** — типичный приём во flex: вместе с `flex: 1` даёт элементу **конкретную вычисленную высоту** от flex-раскладки. От этой высоты считается `height: X%` у `.barFillPoll` / `.barFillTest`.  
  - `display: flex`, `flex-direction: column`, `justify-content: flex-end` — столбик (один flex-ребёнок) прижат к низу, т.е. растёт снизу вверх.

### 3.4 Сам столбик (полоска)

- **`.barFillPoll`, `.barFillTest`**  
  - **`min-height: 4px`** — минимальная высота, когда процент маленький или 0.  
  - `width: 60px` — фиксированная ширина.  
  - Фактическая высота задаётся только из JS: `style={{ height: \`${pPoll}%\` }}` (или `pTest%`).  
  - Процент считается от высоты **`.barWrapper`**. Если у `.barWrapper` не было явной высоты (например, не было `height: 0` + `flex: 1` и не было `align-self: stretch` у `.barGroup`), то `height: 50%` превращался в `auto`, и столбик оставался 4px.

---

## 4. Что было исправлено

1. **`.barGroup`**  
   Добавлен **`align-self: stretch`**, чтобы высота группы столбика не зависела от контента, а была равна высоте `.barsArea`. Так разрывается цикл «высота родителя от контента → процент от родителя».

2. **`.barWrapper`**  
   Оставлен **`height: 0`** в связке с **`flex: 1`**, чтобы у обёртки была однозначная высота от flex, от которой считаются проценты у `.barFillPoll` / `.barFillTest`.

В результате `height: ${pPoll}%` и `height: ${pTest}%` считаются от реальной высоты области диаграммы, и столбик перестаёт «залипать» на 4px.

---

## 5. Данные (откуда берутся проценты)

- **Опрос:** `stats.averageSv`, `stats.averageGdf` — из SSE `/api/stats/stream` (агрегат по коллекции `votes` в Directus).  
- **Тест:** `courseTestSv`, `courseTestGdf` — из `/api/settings` (поля `confa_settings` в Directus).

Если в ответах нули или `null`, столбики будут 0% и визуально только `min-height: 4px`.
